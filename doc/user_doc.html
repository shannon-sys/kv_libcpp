<!DOCTYPE html><html><head><title>Kvlib_C++常用接口函数及使用说明 Version 2.0</title><meta charset='utf-8'><link href='https://cdn.maxiang.io/res-min/themes/marxico.css' rel='stylesheet'><style></style></head><body><div id='preview-contents' class='note-content'>
                        
                    



<h1 id="kvlibc常用接口函数及使用说明-version-20">Kvlib_C++常用接口函数及使用说明 Version 2.0</h1>



<h3 id="version-20-201918-修订">Version 2.0 2019/1/8 修订</h3>



<h1 id="目录">目录</h1>

<div><div class="toc"><div class="toc">
<ul>
<li><a href="#kvlibc常用接口函数及使用说明-version-20">Kvlib_C++常用接口函数及使用说明 Version 2.0</a><ul>
<li><ul>
<li><a href="#version-20-201918-修订">Version 2.0 2019/1/8 修订</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#目录">目录</a><ul>
<li><a href="#一概述">一、概述</a></li>
<li><a href="#二使用">二、使用</a><ul>
<li><a href="#1数据库的打开创建和删除">1、数据库的打开创建和删除</a><ul>
<li><a href="#什么是kv数据库">什么是kv数据库</a></li>
<li><a href="#数据库的基本操作">数据库的基本操作</a></li>
<li><a href="#创建数据库">创建数据库</a></li>
<li><a href="#打开数据库">打开数据库</a></li>
<li><a href="#删除数据库">删除数据库</a></li>
<li><a href="#dboptions">DBOptions</a></li>
<li><a href="#columnfamily的打开创建和删除">ColumnFamily的打开创建和删除</a><ul>
<li><a href="#什么是columnfamily">什么是ColumnFamily</a></li>
<li><a href="#创建columnfamily">创建ColumnFamily</a></li>
<li><a href="#获取columnfamily">获取ColumnFamily</a></li>
<li><a href="#删除columnfamily">删除ColumnFamily</a></li>
<li><a href="#columnfamilyoptions">ColumnFamilyOptions</a></li>
<li><a href="#获取数据库已经创建的数据库中的columnfamily列表">获取数据库已经创建的数据库中的ColumnFamily列表</a></li>
</ul>
</li>
<li><a href="#使用实例">使用实例</a><ul>
<li><a href="#创建columnfamily-1">创建ColumnFamily</a></li>
<li><a href="#打开旧的数据库并且销毁">打开旧的数据库并且销毁</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2数据的增删改查">2、数据的增删改查</a><ul>
<li><a href="#主要api">主要api</a></li>
<li><a href="#readoptions和readoptions">ReadOptions和ReadOptions</a></li>
<li><a href="#实例数据的增删改查">实例，数据的增删改查</a></li>
</ul>
</li>
<li><a href="#3writebatch-的使用">3、WriteBatch 的使用</a><ul>
<li><a href="#什么是writebatch">什么是WriteBatch</a></li>
<li><a href="#主要api-1">主要api</a></li>
<li><a href="#实例writebatch-的使用">实例，WriteBatch 的使用</a></li>
</ul>
</li>
<li><a href="#4snapshot-的使用">4、Snapshot 的使用</a><ul>
<li><a href="#什么是snapshot">什么是Snapshot</a></li>
<li><a href="#主要api-2">主要api</a></li>
<li><a href="#实例snapshot-的使用">实例，Snapshot 的使用</a></li>
</ul>
</li>
<li><a href="#5iterator-的使用">5、Iterator 的使用</a><ul>
<li><a href="#什么是iterator">什么是iterator</a></li>
<li><a href="#主要api-3">主要api</a></li>
<li><a href="#实例iterator-的使用">实例，Iterator 的使用</a></li>
</ul>
</li>
<li><a href="#6slice和status-的使用">6、Slice和status 的使用</a><ul>
<li><a href="#什么是slice">什么是Slice</a></li>
<li><a href="#slice-常用接口">Slice 常用接口</a></li>
<li><a href="#实例创建slice的多种方式以及使用">实例，创建Slice的多种方式以及使用</a></li>
<li><a href="#什么是status">什么是Status</a></li>
<li><a href="#status-相关接口">Status 相关接口</a></li>
<li><a href="#status的简单使用场景">Status的简单使用场景</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>

<h2 id="一概述">一、概述</h2>

<p>Kvlib_c++是为Shannon高性能key-value引擎开发的C++库,仿照Rocksdb的功能实现，实现了kv引擎的基本功能，由于使用的是直接支持kv的ssd，中间省去了一层文件系统，性能会比Rocksdb高好几倍。</p>

<h2 id="二使用">二、使用</h2>



<h3 id="1数据库的打开创建和删除">1、数据库的打开创建和删除</h3>



<h4 id="什么是kv数据库">什么是kv数据库</h4>

<p>支持从key到value的映射，可以将key-value存入数据库中，再使用key将对应的数据库之中相应的key-value值读出来，也可以根据key删除相应的数据，这就是put/get/del操作</p>



<h4 id="数据库的基本操作">数据库的基本操作</h4>

<h4 id="创建数据库">创建数据库</h4>

<p>在打开的时候设置options.create_if_missing = true;就会自动创建新的数据库</p>



<h4 id="打开数据库">打开数据库</h4>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">namespace</span> shannon {
</div><div class="hljs-line"><span class="hljs-function"><span class="hljs-keyword">static</span> Status <span class="hljs-title">Open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Options&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name,</span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; device,</span>
</div><div class="hljs-line"><span class="hljs-function">        DB** dbptr)</span>;
</div><div class="hljs-line"><span class="hljs-comment">//打开数据库需要传入相关参数，数据库操作、数据库名、设备名，这个接口和下面的有所区别，这个会尝试打开默认只有一个名为define的ColumnFamily的数据库，如果相应数据库ColumnFamily不是默认，就会失败，成功或者失败都会返回相关状态，可以根据返回的Status判断。如果打开成功，会给DB*赋值成相应的数据库指针并且在函数内为其分配内存（注意在不需要时删除，防止内存泄露），之后就可以用这个指针操作数据库。</span>
</div><div class="hljs-line">}
</div></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">namespace</span> shannon {
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">static</span> Status <span class="hljs-title">Open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> DBOptions&amp; db_options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name, <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; device,</span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyDescriptor&gt;&amp; column_families,</span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyHandle*&gt;* handles, DB** dbptr)</span>;
</div><div class="hljs-line"><span class="hljs-comment">//和上面的的函数功能相同，打开数据库，但是需要指定ColumnFamilyHandle，并且数目和名字需要对应，否则会打开失败。对于创建过新ColumnFamily的数据库需要用这个打开。</span>
</div><div class="hljs-line">}
</div></code></pre>



<h4 id="删除数据库">删除数据库</h4>

<pre class="prettyprint hljs-dark"><code class="hljs cpp"><div class="hljs-line"><span class="hljs-keyword">namespace</span> shannon {
</div><div class="hljs-line"> <span class="hljs-function">Status <span class="hljs-title">DestroyDB</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; device, <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name, <span class="hljs-keyword">const</span> Options&amp; options)</span></span>;
</div><div class="hljs-line">}
</div><div class="hljs-line"><span class="hljs-comment">//从数据库之中将数据库整个删除</span>
</div></code></pre>



<h4 id="dboptions">DBOptions</h4>

<pre class="prettyprint hljs-dark"><code class="hljs thrift"><div class="hljs-line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DBOptions</span> </span>{
</div><div class="hljs-line"><span class="hljs-comment">//这里只列举部分</span>
</div><div class="hljs-line"><span class="hljs-comment">//在创建数据库的时候设置以下变量再传入可以实现相应功能</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    <span class="hljs-built_in">bool</span> create_if_missing = <span class="hljs-literal">false</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//数据库不存在则创建，默认否</span>
</div><div class="hljs-line">    <span class="hljs-built_in">bool</span> create_missing_column_families = <span class="hljs-literal">false</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//创建不存在的ColumnFamily，默认否</span>
</div><div class="hljs-line">    <span class="hljs-built_in">bool</span> error_if_exists = <span class="hljs-literal">false</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//如果打开时数据库存在则报错，默认否</span>
</div><div class="hljs-line">}
</div></code></pre>



<h4 id="columnfamily的打开创建和删除">ColumnFamily的打开创建和删除</h4>

<h5 id="什么是columnfamily">什么是ColumnFamily</h5>

<p>ColumnFamily是数据库之中的一个结构，一个DB(数据库)下可以有多个ColumnFamily，但是一个ColumnFamily只对应一个DB，在输入数据的时候必须指定到是储存到哪个DB的哪个ColumnFamily，然后数据会储存到指定的位置。同样，获取或者删除数据的时候，也需要指定某个ColumnFamily，才能够对对应的数据进行操作。每个ColumnFamily有自己的配置，数据读写操作也相应的独立。</p>

<h5 id="创建columnfamily">创建ColumnFamily</h5>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">namespace</span> shannon {
</div><div class="hljs-line"><span class="hljs-keyword">class</span> KVImpl : <span class="hljs-keyword">public</span> DB {
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">CreateColumnFamily</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ColumnFamilyOptions&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">                <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; column_family_name,</span>
</div><div class="hljs-line"><span class="hljs-function">                ColumnFamilyHandle** handle) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//在数据库中创建一个ColumnFamily，根据column_family_name(会创建相应的内存在handle)</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">CreateColumnFamilies</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ColumnFamilyOptions&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">            <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt;&amp; column_family_names,</span>
</div><div class="hljs-line"><span class="hljs-function">            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyHandle*&gt;* handles) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//在数据库中创建一组ColumnFamily,根据column_family_name(会创建相应的内存在handle)</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">CreateColumnFamilies</span><span class="hljs-params">(</span></span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyDescriptor&gt;&amp; column_families,</span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyHandle*&gt;* handles) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//在数据库中创建一组ColumnFamily,根据ColumnFamilyDescriptor</span>
</div><div class="hljs-line">    }
</div><div class="hljs-line">}
</div></code></pre>



<h5 id="获取columnfamily">获取ColumnFamily</h5>

<p>用相应的名字构造一个ColumnFamilyDescriptor的对象，再传入Opendb函数之中，会返回相应的ColumnFamilyHandle指针</p>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line">  <span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">string</span>&gt; familie_names;
</div><div class="hljs-line">  <span class="hljs-built_in">vector</span>&lt;ColumnFamilyDescriptor&gt; column_families;
</div><div class="hljs-line">  column_families.push_back(ColumnFamilyDescriptor(familyname, ColumnFamilyOptions()));
</div></code></pre>



<h5 id="删除columnfamily">删除ColumnFamily</h5>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">namespace</span> shannon {
</div><div class="hljs-line"><span class="hljs-keyword">class</span> KVImpl : <span class="hljs-keyword">public</span> DB {
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">DropColumnFamily</span><span class="hljs-params">(ColumnFamilyHandle* column_family)</span> override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//从数据库中删除一个ColumnFamilyHandle</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">DropColumnFamilies</span><span class="hljs-params">(</span></span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyHandle*&gt;&amp; column_families) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//从数据库中删除一组ColumnFamilyHandle</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">DestroyColumnFamilyHandle</span><span class="hljs-params">(ColumnFamilyHandle* column_family)</span> override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//销毁column_family指针所指向的内存（同delete column_family），并不删除数据库之中的数据</span>
</div><div class="hljs-line">    }
</div><div class="hljs-line">}
</div></code></pre>



<h5 id="columnfamilyoptions">ColumnFamilyOptions</h5>

<pre class="prettyprint hljs-dark"><code class="hljs thrift"><div class="hljs-line"><span class="hljs-comment">//一般使用默认的就好了，具体看源码</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-keyword">namespace</span> shannon {
</div><div class="hljs-line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">WriteOptions</span> </span>{
</div><div class="hljs-line">      <span class="hljs-comment">// Default: true</span>
</div><div class="hljs-line">      <span class="hljs-comment">//是否需要立即写到盘上</span>
</div><div class="hljs-line">      <span class="hljs-built_in">bool</span> sync;
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">      <span class="hljs-comment">//是否需要在内存里面缓存一份</span>
</div><div class="hljs-line">      <span class="hljs-comment">// Default: true</span>
</div><div class="hljs-line">      <span class="hljs-built_in">bool</span> fill_cache;
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">      WriteOptions()
</div><div class="hljs-line">          : sync(<span class="hljs-literal">true</span>),
</div><div class="hljs-line">            fill_cache(<span class="hljs-literal">true</span>) {}
</div><div class="hljs-line">      <span class="hljs-comment">//一般调用这个接口构造一个默认的就好了</span>
</div><div class="hljs-line">  };
</div><div class="hljs-line">}
</div></code></pre>



<h5 id="获取数据库已经创建的数据库中的columnfamily列表">获取数据库已经创建的数据库中的ColumnFamily列表</h5>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">namespace</span> shannon {
</div><div class="hljs-line">  <span class="hljs-keyword">static</span> Status DB::ListColumnFamilies(<span class="hljs-keyword">const</span> DBOptions&amp; db_options,
</div><div class="hljs-line">            <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name,
</div><div class="hljs-line">            <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; device,
</div><div class="hljs-line">            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt;* column_families); 
</div><div class="hljs-line"><span class="hljs-comment">//根据数据库名和设备名，可以数据库之中获取所有的column_families的名字，并且用一个string的vector储存起来，可以利用这个函数获取所有的columnfamily名字，再打开数据库，若没有这个数据库，将返回失败。</span>
</div><div class="hljs-line">}
</div></code></pre>



<h4 id="使用实例">使用实例</h4>

<h5 id="创建columnfamily-1">创建ColumnFamily</h5>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> shannon;<span class="hljs-comment">//命名空间</span>
</div><div class="hljs-line">Status s;<span class="hljs-comment">//收集返回的状态</span>
</div><div class="hljs-line"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> dbname = <span class="hljs-string">"testdb"</span>;<span class="hljs-comment">// db的名字</span>
</div><div class="hljs-line"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> driverpath = <span class="hljs-string">"/dev/kvdev0"</span>;<span class="hljs-comment">// 加载驱动的位置，一般默认为"/dev/kvdev0"设备</span>
</div><div class="hljs-line"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> name = <span class="hljs-string">"new_cf"</span>;<span class="hljs-comment">// 新ColumnFamily的名字</span>
</div><div class="hljs-line">DB *db;  <span class="hljs-comment">// 创建储存db指针</span>
</div><div class="hljs-line">Options options; <span class="hljs-comment">// 构造默认的Options</span>
</div><div class="hljs-line">options.create_if_missing = <span class="hljs-literal">true</span>;<span class="hljs-comment">// 如果数据库不存在则创建数据库,创建数据库的方法</span>
</div><div class="hljs-line">ColumnFamilyHandle *dle; <span class="hljs-comment">// 创建储存的handles</span>
</div><div class="hljs-line">s = DB::Open(options, dbname, driverpath, columnfamilies, db);<span class="hljs-comment">//打开只有默认columnfamilies的数据库，只有在数据库还没有创建的时候可以使用</span>
</div><div class="hljs-line">s = db-&gt;CreateColumnFamily(options, name, &amp;dle);<span class="hljs-comment">//创建一个columnfamilies在数据库之中</span>
</div><div class="hljs-line">assert(s.ok());<span class="hljs-comment">//输出结果状态</span>
</div><div class="hljs-line"><span class="hljs-keyword">delete</span> db;<span class="hljs-comment">// 使用过后清除db</span>
</div><div class="hljs-line"><span class="hljs-keyword">delete</span> dle;<span class="hljs-comment">//清除handle</span>
</div></code></pre>



<h5 id="打开旧的数据库并且销毁">打开旧的数据库并且销毁</h5>

<pre class="prettyprint hljs-dark"><code class="hljs cpp"><div class="hljs-line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> shannon;<span class="hljs-comment">//命名空间</span>
</div><div class="hljs-line">Status s;<span class="hljs-comment">//收集返回的状态</span>
</div><div class="hljs-line"><span class="hljs-comment">//这段函数的功能是打开已经创建过的数据库</span>
</div><div class="hljs-line"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> dbname = <span class="hljs-string">"testdb"</span>;<span class="hljs-comment">// db的名字</span>
</div><div class="hljs-line"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> driverpath = <span class="hljs-string">"/dev/kvdev0"</span>;<span class="hljs-comment">// 加载驱动的位置，一般默认为"/dev/kvdev0"设备</span>
</div><div class="hljs-line"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> name = <span class="hljs-string">"new_cf"</span>;<span class="hljs-comment">// 新ColumnFamily的名字</span>
</div><div class="hljs-line">DB *db;<span class="hljs-comment">// 创建储存db指针</span>
</div><div class="hljs-line">Options options;<span class="hljs-comment">// 构造默认的Options</span>
</div><div class="hljs-line"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyHandle *&gt; *handles;<span class="hljs-comment">// 创建储存handles的指针数组</span>
</div><div class="hljs-line"><span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">string</span>&gt; familie_names; <span class="hljs-comment">// 创建获取ColumnFamily名字列表的数组</span>
</div><div class="hljs-line"><span class="hljs-built_in">vector</span>&lt;ColumnFamilyDescriptor&gt; column_families; <span class="hljs-comment">// 创建储存ColumnFamilyDescriptor的数组</span>
</div><div class="hljs-line">s = DB::ListColumnFamilies(options, dbname, driverpath, &amp;familie_names);<span class="hljs-comment">// 获取现有dbname数据库里所有的ColumnFamilies的名字，并且返回给familie_names数组</span>
</div><div class="hljs-line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> familyname : familie_names)
</div><div class="hljs-line">{
</div><div class="hljs-line">   column_families.push_back(ColumnFamilyDescriptor(familyname, ColumnFamilyOptions()));<span class="hljs-comment">// 为所有的名字构造一个ColumnFamilyDescriptor实例并且储存起来，之后打开db的时候需要使用</span>
</div><div class="hljs-line">}
</div><div class="hljs-line">s = DB::Open(options, dbname, driverpath, column_families, handles, &amp;db);<span class="hljs-comment">// 传入ColumnFamilyDescriptor打开数据库，并且把ColumnFamily的信息获取出来储存到handles里面，可以进行接下来的操作</span>
</div><div class="hljs-line">db-&gt;DropColumnFamilies(*handles) ;<span class="hljs-comment">//删除handles里所有的ColumnFamily</span>
</div><div class="hljs-line">shannon::DestroyDB(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; device, <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name, <span class="hljs-keyword">const</span> Options&amp; options);
</div></code></pre>



<h3 id="2数据的增删改查">2、数据的增删改查</h3>

<p>数据是以key-value对的形式储存在数据库里的，在对数据的基本操作的时候需要指定对应的ColumnFamily和数据库，主要是用DB类的接口进行操作</p>



<h4 id="主要api">主要api</h4>



<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">class</span> KVImpl :<span class="hljs-keyword">class</span> DB{
</div><div class="hljs-line"><span class="hljs-comment">//只列出相关接口</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">Put</span><span class="hljs-params">(<span class="hljs-keyword">const</span> WriteOptions&amp; options,<span class="hljs-keyword">const</span> Slice&amp; key,<span class="hljs-keyword">const</span> Slice&amp; value)</span></span>;
</div><div class="hljs-line">  <span class="hljs-comment">//向数据库的default column_families 写入一条key-value数据，如果数据已经存在，则覆盖，返回相应状态。</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">Delete</span><span class="hljs-params">(<span class="hljs-keyword">const</span> WriteOptions&amp; options, <span class="hljs-keyword">const</span> Slice&amp; key)</span></span>;
</div><div class="hljs-line">  <span class="hljs-comment">//从数据库的default column_families删除一条key对应的数据</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">Get</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ReadOptions&amp; options,<span class="hljs-keyword">const</span> Slice&amp; key,<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>* value)</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//从数据库的default column_families获取一条key对应的数据</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"> <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">Put</span><span class="hljs-params">(<span class="hljs-keyword">const</span> WriteOptions&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">        ColumnFamilyHandle* column_family, <span class="hljs-keyword">const</span> Slice&amp; key,</span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> Slice&amp; value) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//向数据库的对应的column_families 写入一条key-value数据，如果数据已经存在，则覆盖，返回相应状态。</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">Delete</span><span class="hljs-params">(<span class="hljs-keyword">const</span> WriteOptions&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">        ColumnFamilyHandle* column_family, <span class="hljs-keyword">const</span> Slice&amp; key) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//从数据库之中对应的column_families删除一条key对应的数据</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">Get</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ReadOptions&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">        ColumnFamilyHandle* column_family, <span class="hljs-keyword">const</span> Slice&amp; key,</span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>* value) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//从数据库之中对应的column_families获取一条key对应的数据，赋值给value</span>
</div><div class="hljs-line">}
</div></code></pre>



<h4 id="readoptions和readoptions">ReadOptions和ReadOptions</h4>



<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">struct</span> ReadOptions {
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-keyword">bool</span> verify_checksums;
</div><div class="hljs-line">  <span class="hljs-comment">//如果为true，那么所有的key都会进行corr校验</span>
</div><div class="hljs-line">  <span class="hljs-comment">//默认false</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-keyword">bool</span> fill_cache;
</div><div class="hljs-line">  <span class="hljs-comment">//这个数据是应该储存在缓存中</span>
</div><div class="hljs-line">  <span class="hljs-comment">//默认是true</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-keyword">const</span> Snapshot* snapshot;
</div><div class="hljs-line">  <span class="hljs-comment">// 如果snapshot不为空，则根据snapshot查询数据（谁创建由谁删除，否则会占用大量资源）</span>
</div><div class="hljs-line">  <span class="hljs-comment">//如果snapshot为空，则创建当前时刻的临时snapshot查询数据，snapshot的时刻为当前时刻</span>
</div><div class="hljs-line">  <span class="hljs-comment">// 后面会提到snapshot的相关事宜</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  ReadOptions()
</div><div class="hljs-line">      : verify_checksums(<span class="hljs-literal">false</span>),
</div><div class="hljs-line">        fill_cache(<span class="hljs-literal">true</span>),
</div><div class="hljs-line">        snapshot(<span class="hljs-literal">NULL</span>) {
</div><div class="hljs-line">  }
</div><div class="hljs-line">  <span class="hljs-comment">//用这个接口获取一个默认的snapshot</span>
</div><div class="hljs-line">};
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-comment">// Options that control write operations</span>
</div><div class="hljs-line"><span class="hljs-keyword">struct</span> WriteOptions {
</div><div class="hljs-line">  <span class="hljs-keyword">bool</span> sync;
</div><div class="hljs-line">  <span class="hljs-comment">// 默认true</span>
</div><div class="hljs-line">  <span class="hljs-comment">// 是否需要立即写到盘上</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-keyword">bool</span> fill_cache;
</div><div class="hljs-line">  <span class="hljs-comment">// 这个数据是应该储存在缓存中</span>
</div><div class="hljs-line">  <span class="hljs-comment">// 默认是true</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"> <span class="hljs-comment">//ues this interface to make a default WriteOptions</span>
</div><div class="hljs-line">  WriteOptions()
</div><div class="hljs-line">      : sync(<span class="hljs-literal">true</span>),
</div><div class="hljs-line">        fill_cache(<span class="hljs-literal">true</span>) {
</div><div class="hljs-line">  }
</div><div class="hljs-line">};
</div></code></pre>



<h4 id="实例数据的增删改查">实例，数据的增删改查</h4>

<pre class="prettyprint hljs-dark"><code class="hljs q"><div class="hljs-line">using namespace shannon;<span class="hljs-comment">//命名空间</span>
</div><div class="hljs-line">Status s;<span class="hljs-comment">//收集返回的状态</span>
</div><div class="hljs-line">std::<span class="hljs-built_in">string</span> dbname = <span class="hljs-string">"testdb"</span>;<span class="hljs-comment">// db的名字</span>
</div><div class="hljs-line">std::<span class="hljs-built_in">string</span> driverpath = <span class="hljs-string">"/dev/kvdev0"</span>;<span class="hljs-comment">// 加载驱动的位置，一般默认为"/dev/kvdev0"设备</span>
</div><div class="hljs-line">std::<span class="hljs-built_in">string</span> name = <span class="hljs-string">"new_cf"</span>;<span class="hljs-comment">// 新ColumnFamily的名字</span>
</div><div class="hljs-line">DB *db;  <span class="hljs-comment">// 创建储存db指针</span>
</div><div class="hljs-line">Options options; <span class="hljs-comment">// 构造默认的Options</span>
</div><div class="hljs-line">options.create_if_missing = false;<span class="hljs-comment">// 关闭创建数据库</span>
</div><div class="hljs-line">ColumnFamilyHandle *dle; <span class="hljs-comment">// 创建储存的handles</span>
</div><div class="hljs-line">s = DB::Open(options, dbname, driverpath, columnfamilies, db);<span class="hljs-comment">//打开只有默认columnfamilies的数据库</span>
</div><div class="hljs-line">s = db-&gt;CreateColumnFamily(options, name, &amp;dle);<span class="hljs-comment">//创建一个columnfamilies在数据库之中</span>
</div><div class="hljs-line"><span class="hljs-built_in">string</span> <span class="hljs-built_in">key</span> = <span class="hljs-string">"key"</span>;<span class="hljs-comment">// 设置key</span>
</div><div class="hljs-line"><span class="hljs-built_in">string</span> <span class="hljs-built_in">value</span>(<span class="hljs-string">"value"</span>);<span class="hljs-comment">// 设置value</span>
</div><div class="hljs-line">s = db-&gt;Put(shannon::WriteOptions(), handel, <span class="hljs-built_in">key</span>, <span class="hljs-built_in">value</span>);<span class="hljs-comment">// 储存key-value</span>
</div><div class="hljs-line"><span class="hljs-built_in">value</span> = <span class="hljs-string">""</span>;<span class="hljs-comment">// 重置value</span>
</div><div class="hljs-line">s = db-&gt;Get(ReadOptions(), handel, <span class="hljs-built_in">key</span>, &amp;<span class="hljs-built_in">value</span>);<span class="hljs-comment">// 获取value</span>
</div><div class="hljs-line">s = db-&gt;Delete(WriteOptions(), handel, slice_key);<span class="hljs-comment">// 删除key</span>
</div><div class="hljs-line"><span class="hljs-comment">// 以上三个是从指定的handle之中操作数据</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">s = db-&gt;Put(shannon::WriteOptions(), <span class="hljs-built_in">key</span>, <span class="hljs-built_in">value</span>);<span class="hljs-comment">// 储存key-value</span>
</div><div class="hljs-line"><span class="hljs-built_in">value</span> = <span class="hljs-string">""</span>;
</div><div class="hljs-line">s = db-&gt;Get(ReadOptions(), <span class="hljs-built_in">key</span>, &amp;<span class="hljs-built_in">value</span>);获取<span class="hljs-built_in">value</span>
</div><div class="hljs-line">s = db-&gt;Delete(WriteOptions(), slice_key);<span class="hljs-comment">// 删除key</span>
</div><div class="hljs-line"><span class="hljs-comment">// 以上三个是从默认的ColumnFamily之中操作数据</span>
</div></code></pre>



<h3 id="3writebatch-的使用">3、WriteBatch 的使用</h3>



<h4 id="什么是writebatch">什么是WriteBatch</h4>

<p>WriteBatch就是大量的操作在一起作为一个整体，具有原子性的特点，它们是一同处理的命令，一同成功一同失败，如果一批操作之中有一个失败了，那么这一批操作都会失败，要不然全部成功要不然全部失败。而WriteBatch是先把需要做的一批操作放到一个WriteBatch之中储存，然后调用Write接口，同时处理这一批操作。目前每个WriteBatch最多只支持1000个命令。</p>



<h4 id="主要api-1">主要api</h4>



<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">class</span> WriteBatch{
</div><div class="hljs-line">   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Put</span><span class="hljs-params">(ColumnFamilyHandle* column_family, <span class="hljs-keyword">const</span> Slice&amp; key,</span></span>
</div><div class="hljs-line"><span class="hljs-function">          <span class="hljs-keyword">const</span> Slice&amp; value)</span>;
</div><div class="hljs-line"><span class="hljs-comment">//  增加一个对column_family写"key-&gt;value" 的操作加入WriteBatch之中</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Put</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Slice&amp; key, <span class="hljs-keyword">const</span> Slice&amp; value)</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//  增加一个对default cf写"key-&gt;value" 的操作加入WriteBatch之中</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Delete</span><span class="hljs-params">(ColumnFamilyHandle* column_family, <span class="hljs-keyword">const</span> Slice&amp; key)</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//  增加一个对column_family删除"key-&gt;value" 的操作加入WriteBatch之中</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Delete</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Slice&amp; key)</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//  增加一个对default cf删除"key-&gt;value" 的操作加入WriteBatch之中</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line"><span class="hljs-comment">// Clear all updates buffered in this batch.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Clear</span><span class="hljs-params">()</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//清除当前所有已经插入的所有操作</span>
</div><div class="hljs-line">}
</div><div class="hljs-line"><span class="hljs-keyword">class</span> KVImpl :<span class="hljs-keyword">class</span> DB{
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">Write</span><span class="hljs-params">(<span class="hljs-keyword">const</span> WriteOptions&amp; options, WriteBatch* updates)</span></span>;
</div><div class="hljs-line">  <span class="hljs-comment">//从数据库的default column_families 执行一个批量的WriteBatch操作，执行updates之中的所有操作，并且保持整个WriteBatch操作的原子性，一起成功或一起失败</span>
</div><div class="hljs-line">}
</div></code></pre>



<h4 id="实例writebatch-的使用">实例，WriteBatch 的使用</h4>

<pre class="prettyprint hljs-dark"><code class="hljs lisp"><div class="hljs-line">    WriteBatch batch<span class="hljs-comment">;</span>
</div><div class="hljs-line">    for (<span class="hljs-name">int</span> i = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 20; ++i) {</span>
</div><div class="hljs-line">        stringstream fs_value<span class="hljs-comment">;</span>
</div><div class="hljs-line">        stringstream fs_key<span class="hljs-comment">;</span>
</div><div class="hljs-line">        fs_key &lt;&lt; <span class="hljs-string">"batch_key"</span> &lt;&lt; i<span class="hljs-comment">;//构造 key</span>
</div><div class="hljs-line">        fs_value &lt;&lt; <span class="hljs-string">"batch_val"</span> &lt;&lt; i<span class="hljs-comment">;//构造 value</span>
</div><div class="hljs-line">        string key = fs_key.str()<span class="hljs-comment">; </span>
</div><div class="hljs-line">        batch.Put(<span class="hljs-name">handle</span> ,fs_key.str(),fs_value.str())<span class="hljs-comment">;// 存储插入数据的指令</span>
</div><div class="hljs-line">        //batch.Delete(<span class="hljs-name">handle</span> ,fs_key.str())<span class="hljs-comment">;//存储删除数据的指令</span>
</div><div class="hljs-line">        batch.Put(<span class="hljs-name">fs_key</span>.str(),fs_value.str())<span class="hljs-comment">;// 存储插入数据的指令 （对default的操作）</span>
</div><div class="hljs-line">        // batch.Delete(<span class="hljs-name">fs_key</span>.str())<span class="hljs-comment">;// 存储删除数据的指令 （对default的操作）</span>
</div><div class="hljs-line">    }
</div><div class="hljs-line">        stringstream fs_value<span class="hljs-comment">;</span>
</div><div class="hljs-line">        stringstream fs_key<span class="hljs-comment">;</span>
</div><div class="hljs-line">        fs_key &lt;&lt; <span class="hljs-string">"batch_key"</span> &lt;&lt; i<span class="hljs-comment">;</span>
</div><div class="hljs-line">        string key = fs_key.str()<span class="hljs-comment">;</span>
</div><div class="hljs-line">        batch.Delete(<span class="hljs-name">handle</span> ,fs_key.str())<span class="hljs-comment">;// 存储删除数据的指令 （对default的操作）</span>
</div><div class="hljs-line">        db-&gt;Write(<span class="hljs-name">WriteOptions</span>(),<span class="hljs-symbol">&amp;batch</span>)<span class="hljs-comment">;// 执行WriteBatch</span>
</div></code></pre>



<h3 id="4snapshot-的使用">4、Snapshot 的使用</h3>



<h4 id="什么是snapshot">什么是Snapshot</h4>

<p>Snapshot是关于指定数据集合的一个完全可用拷贝，该拷贝包括相应数据在某个时间点（拷贝开始的时间点）的映像。在这里Snapshot是一个时间点，通过这个的信息，可以获取在Snapshot创建时刻的数据，而不会被Snapshot创建时刻之后来的命令影响。在很多时刻都会用到，获取数据的时候需要保证数据的一致性，不会出现一半新数据一半是旧数据的情况。但是由于Snapshot需要占用旧数据不让其释放，会相当的占用内存，这里就需要Snapshot在不使用的时候及时释放，这里Snapshot是一个非持久的，断电就会消失，需要持久化的Snapshot可以使用checkpoint。</p>



<h4 id="主要api-2">主要api</h4>



<pre class="prettyprint hljs-dark"><code class="hljs cpp"><div class="hljs-line"><span class="hljs-keyword">class</span> KVImpl :<span class="hljs-keyword">class</span> DB{
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">const</span> Snapshot* <span class="hljs-title">GetSnapshot</span><span class="hljs-params">()</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//创建数据库的一个快照并且返回快照,数据库的快照会导致大量的旧数据残留，需要及时清理不用的快照</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">ReleaseSnapshot</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Snapshot* snapshot)</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//释放快照</span>
</div><div class="hljs-line">  }
</div></code></pre>



<h4 id="实例snapshot-的使用">实例，Snapshot 的使用</h4>

<pre class="prettyprint hljs-dark"><code class="hljs stata"><div class="hljs-line">    <span class="hljs-keyword">const</span> Snapshot* snapshot  = <span class="hljs-keyword">db</span>-&gt;GetSnapshot();<span class="hljs-comment">// 获取当前时刻的Snapshot</span>
</div><div class="hljs-line">    <span class="hljs-keyword">assert</span>(status.ok());
</div><div class="hljs-line">    status = <span class="hljs-keyword">db</span>-&gt;Put(shannon::WriteOptions(), <span class="hljs-string">"hello"</span>, <span class="hljs-string">"mytest"</span>);<span class="hljs-comment">// 插入数据</span>
</div><div class="hljs-line">    <span class="hljs-keyword">assert</span>(status.ok());
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    ReadOptions readoptions; <span class="hljs-comment">//创建options</span>
</div><div class="hljs-line">    readoptions.snapshot = snapshot;<span class="hljs-comment">// 指定Snapshot读取数据</span>
</div><div class="hljs-line">    status = <span class="hljs-keyword">db</span>-&gt;<span class="hljs-built_in">Get</span>(readoptions, <span class="hljs-string">"hello"</span>, &amp;value);<span class="hljs-comment">//获取数据</span>
</div><div class="hljs-line">    <span class="hljs-keyword">assert</span>(status.ok());
</div><div class="hljs-line">    std::cout &lt;&lt; value &lt;&lt; std::endl;<span class="hljs-comment">// 验证</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">    status = <span class="hljs-keyword">db</span>-&gt;ReleaseSnapshot(snapshot);<span class="hljs-comment">// 释放Snapshot</span>
</div><div class="hljs-line">    <span class="hljs-keyword">assert</span>(status.ok());
</div></code></pre>



<h3 id="5iterator-的使用">5、Iterator 的使用</h3>



<h4 id="什么是iterator">什么是iterator</h4>

<p>Iterator是数据库的迭代器，每个columnfamily可以对应生成一个，用Iterator和c++容器的Iterator一样，可以遍历columnfamily中的数据，按照字符串的顺序遍历，支持遍历首个，最后一个，下一个上一个和跳到某个字符串开头的key处（以某个字符串为前缀)。Iterator会自动生成一个Snapshot，来指定遍历数据的时间点，会占用资源，用完应当及时释放。</p>



<h4 id="主要api-3">主要api</h4>



<pre class="prettyprint hljs-dark"><code class="hljs cpp"><div class="hljs-line"><span class="hljs-keyword">class</span> KVImpl {
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Iterator* <span class="hljs-title">NewIterator</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ReadOptions&amp;)</span></span>;
</div><div class="hljs-line"><span class="hljs-comment">//为数据库default column_families创建一个iterator，用来遍历数据</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Iterator* <span class="hljs-title">NewIterator</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ReadOptions&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">        ColumnFamilyHandle* column_family) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//为对应的column_families创建一个iterator，用于遍历数据(会创建相应的内存并且返回，用完需要delete)</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">NewIterators</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ReadOptions&amp; options,</span></span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;ColumnFamilyHandle*&gt;&amp; column_families,</span>
</div><div class="hljs-line"><span class="hljs-function">        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;Iterator*&gt;* iterators) override</span>;
</div><div class="hljs-line"><span class="hljs-comment">//为一组的column_families创建一组iterator，用于遍历数据，每个iterator对应一个column_families(会创建相应的内存在iterators之中，用完需要delete)</span>
</div><div class="hljs-line">}
</div></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-keyword">class</span> Iterator {
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Valid</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//判断当前的位置是否是一个有效的位置</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SeekToFirst</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//使Iterator移动到第一个数据，若没有找到则结果为Valid() = false</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SeekToLast</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//使Iterator移动到最后一个数据，若没有找到则结果为Valid() = false</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Seek</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Slice&amp; target)</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//使Iterator移动到target为前缀的数据，若没有找到则结果为Valid() = false</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Next</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//使Iterator移动到下一个数据处，若没有找到则结果为Valid() = false</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Prev</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//使Iterator移动到上一个数据处，若没有找到则结果为Valid() = false</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> Slice <span class="hljs-title">key</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//获取当前位置的key值，</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> Slice <span class="hljs-title">value</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//获取当前位置value的值</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">status</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//返回当前Iterator的状态</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SeekForPrev</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Slice&amp; target)</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//寻找小于或等于目标键的最后一个键Seek()</span>
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">     <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetPrefix</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Slice &amp;prefix)</span> </span>= <span class="hljs-number">0</span>;
</div><div class="hljs-line">    <span class="hljs-comment">//设置前缀</span>
</div><div class="hljs-line">}
</div></code></pre>



<h4 id="实例iterator-的使用">实例，Iterator 的使用</h4>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line">    Iterator *iter = db-&gt;NewIterator(shannon::ReadOptions());<span class="hljs-comment">// 创建一个Iterator</span>
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> (iter-&gt;SeekToFirst(); iter-&gt;Valid(); iter-&gt;Next()) {<span class="hljs-comment">// 循环</span>
</div><div class="hljs-line">        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; iter-&gt;key().ToString() &lt;&lt; <span class="hljs-string">"-&gt;"</span>
</div><div class="hljs-line">            &lt;&lt; iter-&gt;value().ToString() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<span class="hljs-comment">//打印结果</span>
</div><div class="hljs-line">    }
</div><div class="hljs-line">    iter-&gt;Seek(<span class="hljs-string">"batch2"</span>);<span class="hljs-comment">//转跳</span>
</div><div class="hljs-line">    value = iter-&gt;value().ToString();<span class="hljs-comment">// 获取结果</span>
</div><div class="hljs-line">    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<span class="hljs-comment">// 打印结果</span>
</div><div class="hljs-line">    <span class="hljs-keyword">delete</span> iter;<span class="hljs-comment">// 清除内存，解除占用</span>
</div></code></pre>



<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-built_in">vector</span>&lt;Iterator *&gt; iters;<span class="hljs-comment">//需要接收的指针数组</span>
</div><div class="hljs-line">DB *db；<span class="hljs-comment">//需要打开过的db</span>
</div><div class="hljs-line"><span class="hljs-keyword">const</span> <span class="hljs-built_in">vector</span>&lt;ColumnFamilyHandle *&gt; handles；<span class="hljs-comment">//需要输入的指针</span>
</div><div class="hljs-line">s = db-&gt;NewIterators(ReadOptions(), handles, &amp;iters);<span class="hljs-comment">// 创建一组Iterator</span>
</div><div class="hljs-line"><span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;
</div><div class="hljs-line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> iter : iters)<span class="hljs-comment">// 对每一个Iterator进行操作</span>
</div><div class="hljs-line">{
</div><div class="hljs-line">    <span class="hljs-keyword">for</span> (iter-&gt;SeekToFirst(); iter-&gt;Valid(); iter-&gt;Next())<span class="hljs-comment">// 循环</span>
</div><div class="hljs-line">    {
</div><div class="hljs-line">        Slice slice_key = iter-&gt;key();
</div><div class="hljs-line">        Slice slice_value = iter-&gt;value();
</div><div class="hljs-line">        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" : "</span> &lt;&lt; slice_key.ToString() &lt;&lt; <span class="hljs-string">" : "</span>
</div><div class="hljs-line">                  &lt;&lt; slice_value.ToString() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
</div><div class="hljs-line">        <span class="hljs-comment">//获取并且打印结果</span>
</div><div class="hljs-line">    }
</div><div class="hljs-line">    ++i;
</div><div class="hljs-line">}
</div><div class="hljs-line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> iter : iters)
</div><div class="hljs-line">{
</div><div class="hljs-line">    <span class="hljs-keyword">delete</span> iter; <span class="hljs-comment">//清除内存，解除占用</span>
</div><div class="hljs-line">}
</div></code></pre>



<h3 id="6slice和status-的使用">6、Slice和status 的使用</h3>

<h4 id="什么是slice">什么是Slice</h4>

<p>kv自定义的数据类型，实现了一些对字符串的操作(可以支持储存’/0’)，可以用string，char* 等多种方式初始化</p>



<h4 id="slice-常用接口">Slice 常用接口</h4>

<pre class="prettyprint hljs-dark"><code class="language-cpp hljs"><div class="hljs-line"><span class="hljs-comment">// Create an empty slice.</span>
</div><div class="hljs-line">  Slice() : data_(<span class="hljs-string">""</span>), size_(<span class="hljs-number">0</span>) { }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Create a slice that refers to d[0,n-1].</span>
</div><div class="hljs-line">  Slice(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* d, <span class="hljs-keyword">size_t</span> n) : data_(d), size_(n) { }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Create a slice that refers to the contents of "s"</span>
</div><div class="hljs-line">  Slice(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; s) : data_(s.data()), size_(s.size()) { }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Create a slice that refers to s[0,strlen(s)-1]</span>
</div><div class="hljs-line">  Slice(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* s) : data_(s), size_(<span class="hljs-built_in">strlen</span>(s)) { }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Return a pointer to the beginning of the referenced data </span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">data</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> data_; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Return the length (in bytes) of the referenced data</span>
</div><div class="hljs-line">  <span class="hljs-keyword">size_t</span> size() <span class="hljs-keyword">const</span> { <span class="hljs-keyword">return</span> size_; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Return true iff the length of the referenced data is zero</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">empty</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> size_ == <span class="hljs-number">0</span>; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Drop the first "n" bytes from this slice.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">remove_prefix</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> n)</span></span>
</div><div class="hljs-line"><span class="hljs-function"></span>
</div><div class="hljs-line"><span class="hljs-function">  <span class="hljs-comment">// Return a string that contains the copy of the referenced data.</span></span>
</div><div class="hljs-line"><span class="hljs-function">  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(data_, size_); }
</div><div class="hljs-line"><wbr>
</div></code></pre>



<h4 id="实例创建slice的多种方式以及使用">实例，创建Slice的多种方式以及使用</h4>

<pre class="prettyprint hljs-dark"><code class="hljs q"><div class="hljs-line"><span class="hljs-type">int</span> key_len = strlen(<span class="hljs-built_in">key</span>),value_len = strlen(<span class="hljs-string">"value"</span>);<span class="hljs-comment">//获取长度</span>
</div><div class="hljs-line">Slice <span class="hljs-built_in">key</span> = Slice(<span class="hljs-string">"k\0ey"</span>, key_len+<span class="hljs-number">1</span>);<span class="hljs-comment">// 含有/0需要传入长度参数</span>
</div><div class="hljs-line">Slice <span class="hljs-built_in">value</span> = Slice(<span class="hljs-string">"v\0alue"</span>, value_len+<span class="hljs-number">1</span>);<span class="hljs-comment">// 含有/0需要传入长度参数</span>
</div><div class="hljs-line">db-&gt;Put(options,<span class="hljs-built_in">key</span>,<span class="hljs-built_in">value</span>);
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">Slice <span class="hljs-built_in">key</span> = Slice(<span class="hljs-string">"key"</span>); <span class="hljs-comment">// 字符串初始化</span>
</div><div class="hljs-line">Slice <span class="hljs-built_in">value</span> = Slice(<span class="hljs-string">"value"</span>);<span class="hljs-comment">// 字符串初始化</span>
</div><div class="hljs-line">db-&gt;Put(options,<span class="hljs-built_in">key</span>,<span class="hljs-built_in">value</span>);
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">char* keyptr = <span class="hljs-string">"k\0ey"</span>;
</div><div class="hljs-line">cahr* valueptr <span class="hljs-string">"v\0alue"</span>;
</div><div class="hljs-line">Slice <span class="hljs-built_in">key</span> = Slice(keyptr,key_len+<span class="hljs-number">1</span>); <span class="hljs-comment">// char*初始化</span>
</div><div class="hljs-line">Slice <span class="hljs-built_in">value</span> = Slice(valueptr,key_len+<span class="hljs-number">1</span>);<span class="hljs-comment">// char*初始化</span>
</div><div class="hljs-line">db-&gt;Put(options,<span class="hljs-built_in">key</span>,<span class="hljs-built_in">value</span>);
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">std::cout &lt;&lt;  <span class="hljs-built_in">value</span>.ToString() &lt;&lt; endl;<span class="hljs-comment">// 输出</span>
</div></code></pre>



<h4 id="什么是status">什么是Status</h4>



<h4 id="status-相关接口">Status 相关接口</h4>

<pre class="prettyprint hljs-dark"><code class="hljs"><div class="hljs-line">用来定义函数的返回状态,包括错误字符串等相关信息
</div></code></pre>

<pre class="prettyprint hljs-dark"><code class="hljs cpp"><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates success.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">ok</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kOk; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates a NotFound error.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsNotFound</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kNotFound; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates a Corruption error.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsCorruption</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kCorruption; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates a NotSupported error.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsNotSupported</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kNotSupported; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates an InvalidArgument error.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsInvalidArgument</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kInvalidArgument; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates an IOError.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsIOError</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kIOError; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates an MergeInProgress.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsMergeInProgress</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kMergeInProgress; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates Incomplete</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsIncomplete</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kIncomplete; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates Shutdown In progress</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsShutdownInProgress</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kShutdownInProgress; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates TimedOut</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsTimedOut</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kTimedOut; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates Aborted</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsAborted</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kAborted; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates Aborted</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsLockLimit</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{
</div><div class="hljs-line">    <span class="hljs-keyword">return</span> code() == kAborted &amp;&amp; subcode() == kLockLimit;
</div><div class="hljs-line">  }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates that a resource is Busy and</span>
</div><div class="hljs-line">  <span class="hljs-comment">// temporarily could not be acquired.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsBusy</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kBusy; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates Deadlock</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsDeadlock</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kBusy &amp;&amp; subcode() == kDeadlock; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicated that the operation has Expired.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsExpired</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kExpired; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates a TryAgain error.</span>
</div><div class="hljs-line">  <span class="hljs-comment">// This usually means that the operation failed, but may succeed if</span>
</div><div class="hljs-line">  <span class="hljs-comment">// re-attempted.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsTryAgain</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kTryAgain; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates the proposed compaction is too large</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsCompactionTooLarge</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> code() == kCompactionTooLarge; }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates a NoSpace error</span>
</div><div class="hljs-line">  <span class="hljs-comment">// This is caused by an I/O error returning the specific "out of space"</span>
</div><div class="hljs-line">  <span class="hljs-comment">// error condition. Stricto sensu, an NoSpace error is an I/O error</span>
</div><div class="hljs-line">  <span class="hljs-comment">// with a specific subcode, enabling users to take the appropriate action</span>
</div><div class="hljs-line">  <span class="hljs-comment">// if needed</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsNoSpace</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{
</div><div class="hljs-line">    <span class="hljs-keyword">return</span> (code() == kIOError) &amp;&amp; (subcode() == kNoSpace);
</div><div class="hljs-line">  }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns true iff the status indicates a memory limit error.  There may be</span>
</div><div class="hljs-line">  <span class="hljs-comment">// cases where we limit the memory used in certain operations (eg. the size</span>
</div><div class="hljs-line">  <span class="hljs-comment">// of a write batch) in order to avoid out of memory exceptions.</span>
</div><div class="hljs-line">  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">IsMemoryLimit</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{
</div><div class="hljs-line">    <span class="hljs-keyword">return</span> (code() == kAborted) &amp;&amp; (subcode() == kMemoryLimit);
</div><div class="hljs-line">  }
</div><div class="hljs-line"><wbr>
</div><div class="hljs-line">  <span class="hljs-comment">// Return a string representation of this status suitable for printing.</span>
</div><div class="hljs-line">  <span class="hljs-comment">// Returns the string "OK" for success.</span>
</div><div class="hljs-line">  <span class="hljs-built_in">std</span>::<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>;
</div></code></pre>

<h4 id="status的简单使用场景">Status的简单使用场景</h4>



<pre class="prettyprint hljs-dark"><code class="hljs kotlin"><div class="hljs-line">s = <span class="hljs-keyword">this</span>-&gt;DropColumnFamily(column_family_handle);
</div><div class="hljs-line"><span class="hljs-keyword">if</span> (!s.ok()) {
</div><div class="hljs-line">    cout &lt;&lt; s.ToString(); 
</div><div class="hljs-line">    <span class="hljs-keyword">return</span> s;
</div><div class="hljs-line">}
</div><div class="hljs-line"><span class="hljs-keyword">if</span> (flag1){
</div><div class="hljs-line">    <span class="hljs-keyword">return</span> Status::NoSpace(<span class="hljs-string">"flag1"</span>);
</div><div class="hljs-line">}
</div><div class="hljs-line"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flag2){
</div><div class="hljs-line">     <span class="hljs-keyword">return</span> Status::IsMemoryLimit();
</div><div class="hljs-line">}
</div><div class="hljs-line"><span class="hljs-keyword">else</span> {
</div><div class="hljs-line">    <span class="hljs-keyword">return</span> Status::NoSpace(<span class="hljs-string">"flag2"</span>);
</div><div class="hljs-line">}
</div></code></pre></div></body></html>